---
title: "Writing to a REDCap Project"
author: Will Beasley [Biomedical & Behavior Methodology Core](https://www.ouhsc.edu/bbmc/team/), OUHSC Pediatrics;<br>Raymond Balise, University of Miami School of Medicine
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Writing to a REDCap Project}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| include = FALSE
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy    = FALSE
)
```

Writing data _to_ REDCap is more difficult than reading data _from_ REDCap.
When you read, you receive data in the structure that the REDCap provides you.
You have some control about the columns, rows, and data types,
but there is not a lot you have to be concerned.

In contrast, the structure of the dataset you send to the REDCap server must be precise.
You need to pass special variables so that the REDCap server understands the
hierarchical structure of the data points.
This vignette walks you through that process.

If you are new to REDCap and its API,
please first understand the concepts described in these two [vignettes](https://ouhscbbmc.github.io/REDCapR/articles/):

* [Typical REDCap Workflow for a Data Analyst](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html)
* [Retrieving Longitudinal and Repeating Structures](https://ouhscbbmc.github.io/REDCapR/articles/longitudinal-and-repeating.html)

Part 1 - Pre-requisites
===================================

See the [Typical REDCap Workflow for a Data Analyst](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html)
vignette and

1. [Verify REDCapR is installed](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html#verify-redcapr-is-installed)
1. [Verify REDCap Access](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html#verify-redcap-access)
1. [Review Codebook](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html#review-codebook)


Retrieve Token
-------------------------

Please closely read the 
[Retrieve Protected Token](https://ouhscbbmc.github.io/REDCapR/articles/workflow-read.html#part-2---retrieve-protected-token) section,
which has important security implications.  
The current vignette imports a fake dataset into REDCap,
and we'll use a token stored in a local file.

```{r retrieve-credential}
path_credential <- system.file("misc/example.credentials", package = "REDCapR")
credential  <- REDCapR::retrieve_credential_local(
  path_credential = path_credential,
  project_id      = 3748
)

c(credential$redcap_uri, credential$token)
```

Datasets to Write to Server
-------------------------

For the purposes of this vignette, we'll start with the data that needs to be written.  
These example tables were prepared by [Raymond Balise](https://github.com/RaymondBalise) 
for our 2023 [R/Medicine](https://events.linuxfoundation.org/r-medicine/) workshop,
"Using REDCap and R to Rapidly Produce Biomedical Publications".

There are two tables, each with a different [granularity](https://www.1keydata.com/datawarehousing/fact-table-granularity.html): 

* `ds_patient`: each row represents one patient, 
* `ds_daily`: each row represents one daily measurement per patient.

```{r load-patient}
ds_patient <-
  "test-data/vignette-repeating-write/data-patient.rds" |>
  system.file(package = "REDCapR") |>
  readr::read_rds()

ds_patient
```


```{r load-repeating}
ds_daily <-
  "test-data/vignette-repeating-write/data-daily.rds" |>
  system.file(package = "REDCapR") |>
  readr::read_rds()

ds_daily
```


Part 2 - Write Data: One row per patient
===================================

Besides the [data.frame] to write to REDCap,
the only required arguments of the
[`REDCapR::redcap_write()`](https://ouhscbbmc.github.io/REDCapR/reference/redcap_write.html)
function are `redcap_uri` and `token`;
both are contained in the credential object created in the previous section.

As discussed in the [Troubleshooting vignette](https://ouhscbbmc.github.io/REDCapR/articles/TroubleshootingApiCalls.html#writing),
we recommend running at least two preliminary checks before trying to write the
dataset to the server for the very first time.


Prep: `REDCapR::validate_for_write()`
-------------------------

`REDCapR::validate_for_write()` inspects a data frame to anticipate potential problems before writing with REDCap's API.
A tibble is returned, with one row per potential problem (and a suggestion how to avoid it).
Ideally an 0-row tibble is returned.

```{r patient-validate}
REDCapR::validate_for_write(ds_patient, convert_logical_to_integer = TRUE)
```

If you encounter problems that can be checked with automation, 
please tell us in [an issue](https://github.com/OuhscBbmc/REDCapR/issues) and
we'll work with you to incorporate the new check into `REDCapR::validate_for_write()`.

When a dataset's problems are caught before reaching the server,
the solutions are easier to identify and implement.


Prep: Write Small Subset First
-------------------------

If this is your first time with a complicated project, consider loading a small subset of rows and columns.

```{r patient-subset}
ds_patient |> 
  dplyr::select(
    id_code,
    date,
    is_mobile,
  ) |> 
  dplyr::slice(1:2) |> 
  REDCapR::redcap_write(
    ds_to_write = _,
    redcap_uri  = credential$redcap_uri,
    token       = credential$token,
    convert_logical_to_integer = TRUE
  )
```


Write Entire Patient-level Table
-------------------------

If the small subset works, we usually try to upload all columns and rows.
If this larger table fails, split the difference between
(a) the smaller working example and 
(b) the larger failing example.  
See if this middle point (that has fewer rows and/or columns than the failing point)
succeeds or fails.  
Then repeat.
This "bisection" or "binary search" [debugging technique](https://medium.com/codecastpublication/debugging-tools-and-techniques-binary-search-2da5bb4282c7) is helpful in many areas of programming and statistical modeling.

```{r patient-complete}
ds_patient |> 
  REDCapR::redcap_write(
    ds_to_write = _,
    redcap_uri  = credential$redcap_uri,
    token       = credential$token,
    convert_logical_to_integer = TRUE
  )
```



Part 3 - Write Data: Repeating Instrument
===================================



*Pause here in the workshop for a few minutes.  Raise hand if you're having trouble.*

Part 6 - Next Steps
===================================

Batching
-------------------------

**Adopt this for writing**

By default, `REDCapR::redcap_read()` requests datasets of 100 patients as a time, and stacks the resulting subsets together before returning a data.frame.  This can be adjusted to improve performance; the 'Details' section of [`REDCapR::redcap_read()`](https://ouhscbbmc.github.io/REDCapR/reference/redcap_read.html#details) discusses the trade offs.

Writing to the Server
-------------------------

<!--
Reading record data is only one API capability.  REDCapR [exposes 20+ API functions](https://ouhscbbmc.github.io/REDCapR/reference/), such as reading metadata, retrieving survey links, and writing records back to REDCap.
-->

Notes
===================================

This vignette was originally designed for a 2023 R/Medicine REDCap workshop with [Raymond R. Balise](https://github.com/RaymondBalise), and others...

This work was made possible in part by the NIH grant [U54GM104938](https://taggs.hhs.gov/Detail/AwardDetail?arg_AwardNum=U54GM104938&arg_ProgOfficeCode=127) to the [Oklahoma Shared Clinical and Translational Resource)](http://osctr.ouhsc.edu).
